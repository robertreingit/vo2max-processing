---
title: ''
output: pdf_document
bibliography: ../references.bib
---

# Methods

The work presented in this thesis was preregistered before the start of the project on the [Open Science Framework](https://osf.io/3am4s) [@foster2017], following the 'Inclusive Systematic Review Registration Form' [@akker2020]. Any deviations from the preregistration are indicated in the 'Transparent Changes' document (Appendix A.1). Major deviations will also be explicitly stated within the methods section. All data and code of this research project can be found on [GitHub](https://www.github.com/smnnlt/vo2max-processing).

I conducted all analyses using R Version 4.1.2 [@rcoreteam2022]. The thesis was entirely written in R Markdown Version 1.1 [@allaire2022]. The attached packages and default settings are documented in Appendix A.4.

## Systematic Scoping Review

The aim of the scoping review was to systematically map current practices of data processing for V̇O~2max~ determination in the scientific literature. Since determining V̇O~2max~ is a far too common procedure to perform an exhaustive search, I randomly sampled 500 articles that referred to V̇O~2max~ or similar keywords. Data on processing strategies were extracted from all sampled articles that directly measured V̇O~2max~ using an appropriate testing procedure in humans.

The review was performed in accordance to the PRISMA extension for Scoping reviews [@tricco2018]. Appendix A.2 contains the corresponding reporting checklist.

### Search & Screening

The article search was conducted on 16th March 2022 using [PubMed]() and [Web of Science](). The search included articles published from 2017 to 2022 referring to 'maximum oxygen uptake' or equivalent terms in title, abstract or keywords. Table 1 shows the exact search terms used.

```{r terms, echo = FALSE}
out <- data.frame(
  source = c("PubMed", "Web of Science"),
  term = c('`((((("maximum oxygen uptake") OR ("maximal oxygen uptake")) OR ("VO2max")) OR ("maximum oxygen consumption")) OR ("maximal oxygen consumption")) AND (("2017/01/01"[Date - Publication] : "3000"[Date - Publication]))`', '`(((((ALL=("maximum oxygen uptake")) OR ALL=("maximal oxygen uptake")) OR ALL=("VO2max")) OR ALL=("maximum oxygen consumption")) OR ALL=("maximal oxygen consumption")) AND PY=(2017-2022)`')
)

knitr::kable(out, 
  col.names = c("Source", "Search String"), 
  caption = "Search strings for the systematic scoping review."
)
```

The search results from both data bases were merged and checked for the presence of a Digital Object Identifier (DOI). Entries without DOI were excluded to allow for automated removal of duplicates by DOI matching in the next step. After removing the duplicates I conducted an automated title scanning to exclude results that were likely no original research articles. Table 2 displays the exclusion terms for the automated title screening.

```{r titlescan, echo = FALSE}
out <- data.frame(
  term = c("review, correction, meta-analysis, comment, retraction, editorial, erratum, reply")
)

knitr::kable(out, 
  col.names = c("Search terms for exclusion by title"), 
  caption = "Exclusion terms for the automated title screening after removal of duplicates. If the title matched at least one of the given terms, the article was excluded.")
```

In accordance with the preregistration I drew a random sample from the search results. The goal of this process was to give an unbiased estimate of the current state of scientific V̇O~2max~ testing. Based on the procedure described in the preregistration, the sample included a total of 500 articles.

The abstracts from the articles included in the random sample were blinded for scanning. This meant removing any further information not relevant for the screening---such as authors or journal---leaving only the title, abstract and an ID of the article (see Appendix A.3 for an example). Two researchers independently scanned the abstracts to filter those that matched one of the exclusion criteria shown in Table 3. When the screeners disagreed in their assessments, they resolved the conflict by discussion.

```{r exclusion, echo = FALSE}
exclusion_criteria <- data.frame(
  id = c("A*", "B*", "C*", "D*", "E", "F"),
  criteria = c("not in English", "no primary research", "research not in humans", "VO2max only estimated", "no appropriate test protocol", "no information regarding the exclusion criteria"),
  details = c("Full text only available in non-English language", "research was no original investigation or only a reanalysis of data", "research was conducted in animals", "VO2max was only approximated by means of a predictive equation", "Protocol for VO2max testing did either not include exercise to voluntial exhaustion or was to long (>20 min) for a reliable estimate", "crucial information on VO2max testing that allowed the evaluation of the other exclusion criteria were missing")
)

knitr::kable(
  exclusion_criteria,
  col.names = c("", "Criterium", "Details"),
  caption = "Exclusion criteria for the screening process. During the abstract screening only the criteria marked with an asterix were evaluated; during full text screening all criteria were assessed."
)
```

After the abstract screening I retrieved the full texts for all articles remaining in the review. The full texts were again independently scanned by two researchers to include only those articles that measured V̇O~2max~ using an appropriate testing procedure in humans (see Table 3 for the detailed full-text exclusion criteria). Conflicts were resolved by discussion.

All data exclusion steps are documented in an Markdown script on [GitHub](https://github.com/smnnlt/vo2max-processing/blob/master/scripts/review.md).

### Data Extraction

I retrieved data from all articles remaining after the abstract and full-text screening. Extraction included the following data:

-   metabolic cart used
-   measurement type (breath-by-breath, mixing chamber, ...)
-   type of outcome for V̇O~2max~ (primary, secondary, other)
-   data preprocessing (e.g., filtering)
-   data processing software
-   interpolation procedure
-   data processing/determination of V̇O~2max~:
    -   type (time average, breath average, digital filtering)
    -   alignment (rolling, binned, ...)
    -   interval (in seconds or breaths, parameters for filtering)
-   reference for the used data processing strategy

The criteria 'type of outcome' and 'reference' were added to the extraction list after the abstracts had been scanned, thus they were not stated in the preregistration. All extracted data is available as a csv file on [GitHub](https://github.com/smnnlt/vo2max-processing/blob/master/data/extract/extraction.csv).

### Data Synthesis

The extracted data is presented in a purely descriptive way. I calculated the relative and absolute frequency for the reporting of the extracted items. Similarly, I counted the use of different data strategies for processing data in all articles that reported measuring breath-by-breath. Total interval duration of averaging procedures were derived from the reported parameters.

## Experimental Comparison

To determine the influence the most common data processing strategies have on the determination of V̇O~2max~, I compared them on a set of already collected gas exchange data from ramp tests in running.

### Data Source

A total of N = 72 exercise tests were analysed for this study. Due to a miscalculation, the preregistration had incorrectly stated a number of 76 tests. The data was from previous research on the metabolic profile of endurance runners [@quittmann_unpubl_a; @quittmann_unpubl_b]. The tested individuals were experienced distance runners (15 female, 54 male; three of the males participated in both studies). The V̇O~2max~ tests were conducted in March to September 2019 [@quittmann_unpubl_a] and March to October 2021 [@quittmann_unpubl_b] using an identical exercise protocol. Participants run on a treadmill (saturn 300/100, h/p/cosmos sports & medical 127 GmbH, Nussdorf-Traunstein, Germany) with 1% inclination for ten minutes at a velocity of 2.8 m·s^-1^ as a warm-up. After preparing the gas exchange measures, they started a ramp protocol with an initial speed of 2.8 m·s^-1^ for two minutes and subsequently increased velocity by 0.15 m·s^-1^ every 30 seconds. The researchers provided verbal encouragement and terminated the exercise when the participants reached subjective exhaustion.

Gas exchange data were recorded using a ZAN 600 device (nSpire Health, Inc., Longmont, CO, United States of America). The device was calibrated with a 3l-syringe pump (nSpire Health, Inc., Longmont, CO, 143 United States of America) and a reference gas (15% O~2~, 6% CO~2~) before each measurement. The measured breath-by-breath data is available on [GitHub](https://github.com/smnnlt/vo2max-processing/tree/master/data/ramptests).

### Data Processing

The spiro Package Version XXX for R [@nolte2022] processed the raw gas exchange data. It includes various algorithms to calculate V̇O~2max~ with user-defined parameters on given data. The full analysis script is available on [GitHub](https://github.com/smnnlt/vo2max-processing/blob/master/scripts/comparison.md).

#### Time based averaging

Moving time based averages were calculated by initially linearly interpolating the breath-by-breath data to seconds. Subsequently a (center aligned) moving average was calculated over a defined timespan. These processing steps are implemented in the spiro package [@nolte2022]. For calculating the moving average over 30 seconds for example, I used the functions `spiro(data) |> spiro_max(30)`.

Binned time averages were calculated using a custom function (available in the [analysis script](https://github.com/smnnlt/vo2max-processing/blob/master/scripts/comparison.md) on GitHub). Breath-by-breath data was initially interpolated to full seconds and then binned into consecutive interval of a constant length. The average of each interval was aligned to its center. Incomplete intervals (i.e. the last seconds of measurement) were not considered in the analysis. Note that some authors use a different procedure for determining their bins, starting by the end point of the measurement. However, defining bins beginning by the start of the measurement is a common output option for many gas exchange data analysis software.

#### Breath based averaging

Breath based moving averages were calculated on the raw data. As this functionality is implemented in the spiro package, I used the functions `spiro(data) |> spiro_max("30b")` for an exemplary 30-breath long averaging interval.

#### Butterworth filtering

Butterworth filters are a class of recursive digital filters. @robergs2010 and @weir2004 argue that these more advanced processing strategies are superior to the traditional moving or binned average approach for analysing gas exchange data. However @robergs2010 missed to account for the time lag introduced by Butterworth filters. Therefore I applied a zero-phase Butterworth filter by means of a forward-backward filtering. While this effectively zeroes out the time lag, the resulting filter is non-causal, which means it can non be used online (i.e. in real time). However, for the present application, an offline filter is sufficient. The forward-backward filtering also introduces transients at both ends of the signal [@gustafsson1996]. I therefore padded the reverted signal at both the start and the end of the array (identical to the 'even padtype' in Python's `scipi.signal.filtfilt()` function [@virtanen2020]). I used 3 as the order parameter and 0.04 as the cut-off frequency for each filter [@robergs2010]. Note that due to the forward-backward approach both the overall order and overall cut-off frequency are different from these values. The described approach is implemented in the spiro package [@nolte2022], and can be used by calling, for example, the functions `spiro(data) |> spiro_max("0.04fz3")`.

### Comparison of methods

To compare different processing methods within and between individuals, I choose to express the V̇O~2max~ normalized to a reference procedure. The reference procedure was chosen as being the most commonly applied in current literature as determined by the systematic review. Individual V̇O~2max~ values were expressed in reference to this procedure, where a value of 1 means that the processing method yields exactly the same V̇O~2max~ value as the reference method. I calculated the data for all integer parameter values within the range of the values found in the literature during the review. On a group level I calculated the median and 10%- and 90%-quantiles of each processing strategy.

In an additional exploratory analysis I investigated the respiratory rate (number of breaths per minute) during the ramp tests. This may help to understand how breath-based and time-based data processing methods relate to each other.
